{
  "id" : "3bea686c-91ec-4bc9-861b-344ab8c3b11a",
  "code" : "sql",
  "document_type" : "node_type",
  "data" : {
    "code" : "sql",
    "name" : "SQL",
    "group" : "Bases de datos",
    "react_component_type" : "AngieDefaultNode",
    "json_data_schema" : "{\n    \"description\": \"Execute SQL queries\",\n    \"type\": \"object\",\n    \"required\": [\n        \"url\",\n        \"type\",\n        \"user\",\n        \"password\",\n        \"driver\",\n        \"query\"\n    ],\n    \"properties\": {\n        \"label\": {\n            \"type\": \"string\"\n        },\n        \"url\": {\n            \"title\": \"URL\",\n            \"type\": \"string\"\n        },\n        \"type\": {\n            \"title\": \"Tipo\",\n            \"type\": \"number\",\n            \"enum\": [\n                1,\n                2,\n                3,\n                4\n            ],\n            \"enumNames\": [\n                \"SELECT\",\n                \"INSERT\",\n                \"UPDATE\",\n                \"DELETE\"\n            ]\n        },\n        \"user\": {\n            \"title\": \"Usuario\",\n            \"type\": \"string\"\n        },\n        \"password\": {\n            \"title\": \"Contraseña\",\n            \"type\": \"string\"\n        },\n        \"driver\": {\n            \"title\": \"Driver\",\n            \"type\": \"string\"\n        },\n        \"query\": {\n            \"title\": \"Query\",\n            \"type\": \"string\"\n        },\n        \"query_params\": {\n            \"title\": \"Parámetros\",\n            \"type\": \"array\",\n            \"items\": {\n                \"type\": \"object\",\n                \"required\": [\n                    \"code\",\n                    \"value\",\n                    \"scope\"\n                ],\n                \"properties\": {\n                    \"code\": {\n                        \"title\": \"Clave\",\n                        \"type\": \"string\"\n                    },\n                    \"value\": {\n                        \"title\": \"Valor\",\n                        \"type\": \"string\"\n                    },\n                    \"scope\": {\n                        \"title\": \"Ámbito\",\n                        \"type\": \"string\",\n                        \"enum\": [\n                            \"BODY\",\n                            \"HEADER\",\n                            \"CONSTANTE\"\n                        ],\n                        \"enumNames\": [\n                            \"BODY\",\n                            \"HEADER\",\n                            \"CONSTANTE\"\n                        ]\n                    }\n                }\n            }\n        }\n    }\n}",
    "json_ui_schema" : "{\n    \"ui:classNames\": \"row\",\n    \"url\": {\n        \"ui:classNames\": \"col-9\",\n        \"ui:help\": \"jdbc:[dialect]://[host]:[port]/[database]\"\n    },\n    \"type\": {\n        \"ui:classNames\": \"col-3\"\n    },\n    \"user\": {\n        \"ui:classNames\": \"col-4\"\n    },\n    \"password\": {\n        \"ui:classNames\": \"col-4\",\n        \"ui:widget\": \"password\"\n    },\n    \"driver\": {\n        \"ui:classNames\": \"col-4\",\n        \"ui:help\": \"com.mysql.jdbc.Driver\"\n    },\n    \"query\": {\n        \"ui:classNames\": \"col-12\",\n        \"ui:widget\": \"AceEditorWidget\",\n        \"ui:mode\": \"sql\",\n        \"ui:beautify\": true,\n        \"ui:height\": \"150px\",\n        \"ui:help\": \"La parametrización es mediante (:)  Por ejemplo: SELECT * FROM t WHERE id = :id;\"\n    },\n    \"query_params\": {\n        \"ui:classNames\": \"col-12\",\n        \"items\": {\n            \"ui:classNames\": \"row\",\n            \"code\": {\n                \"ui:classNames\": \"col-4\",\n                \"ui:help\": \"Clave específicada en la consulta\"\n            },\n            \"value\": {\n                \"ui:classNames\": \"col-4\",\n                \"ui:help\": \"Valor con el que se sustituirá\"\n            },\n            \"scope\": {\n                \"ui:classNames\": \"col-4\",\n                \"ui:help\": \"De dónde sale el valor que se sustituirá\"\n            }\n        }\n    }\n}",
    "xml_template" : "<route  id=\"{{source}}\">\n    <from uri=\"direct:{{source}}\"/>\n    {{applyUnmarshal input_format input_format_options}}\n    <setBody>\n        <groovy>\n<![CDATA[\nimport java.sql.*; \nimport groovy.sql.Sql;\nimport java.sql.Driver;\nimport groovy.json.JsonSlurper;\nimport groovy.json.JsonOutput;\n\ndef driver = Class.forName(\"{{safe driver}}\").newInstance() as Driver\n\njava.util.Properties info = new java.util.Properties();\ninfo.put(\"user\", \"{{safe user}}\");\ninfo.put(\"password\", \"{{safe password}}\");\n\ndef connection = driver.connect(\"{{safe url}}\", info);\n\ndef sql = Sql.newInstance(connection)\n\ndef result;\n\njsonBody = JsonOutput.toJson(request.getBody())\ndef parserJson = new JsonSlurper()\ndef body = parserJson.parseText(jsonBody)\n\ndef queryParams = [:]\ndef counterParams = 0;\nfor (paramvalue in {{groovyList query_params}}) {\n    def item = [:]\n    if (paramvalue.scope == \"BODY\") {\n        queryParams[paramvalue.code] = body[paramvalue.value];\n    } else if (paramvalue.scope == \"HEADER\") {\n        queryParams[paramvalue.code] = request.getHeaders().get(paramvalue.value);\n    } else {\n        queryParams[paramvalue.code] = paramvalue.value;\n    }\n}\n\nif ({{type}} == 1) {\n    result = [:];\n    def counter = 0;\n    sql.eachRow(\"{{safe query}}\", queryParams){ row ->\n        def item = [:]\n        (1..row.getMetaData().columnCount).each {\n            item[\"${row.getMetaData().getColumnName( it )}\"] = row[ it - 1 ];\n        }\n        result[counter++] = item;\n    }\n} else { \n    sql.connection.autoCommit = false\n    try {\n        if ({{type}} == 2) {\n            result = sql.executeInsert(\"{{safe query}}\", queryParams);\n        }\n        if ({{type}} == 3) {\n            result = sql.executeUpdate(\"{{safe query}}\", queryParams);\n        }\n        if ({{type}} == 4) {\n            result = sql.execute(\"{{safe query}}\", queryParams);\n        }\n        sql.commit()\n    } catch(Exception ex) {\n        sql.rollback()\n    }\n}\n\nsql.close()\n\n//return new com.fasterxml.jackson.databind.ObjectMapper().writeValueAsString(result);\n return result;\n]]>\n        \n        \n        \n        \n        </groovy>\n    </setBody>\n    {{applyMarshal output_format output_format_options}}\n    {{generateDestination target}}\n</route>",
    "defaults" : "{\n    \"query\": \"\",\n    \"input_format\": \"raw\",\n    \"output_format\": \"raw\"\n}",
    "id" : "3bea686c-91ec-4bc9-861b-344ab8c3b11a",
    "handles" : "in,out",
    "package_code" : "angie.core",
    "package_version" : "1.1.0",
    "filename" : "sql.json"
  },
  "package_code" : null,
  "package_version" : null
}